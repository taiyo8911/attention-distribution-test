# 注意配分検査:運転適正検査 アプリ仕様書

## 1. アプリ概要
- **アプリ名**: 注意配分検査:運転適正検査
- **対象**: 鉄道操縦者の適性検査
- **プラットフォーム**: iOS (iPhone/iPad)
- **画面向き**: 縦向きのみ

## 2. アーキテクチャ・ファイル構成

### 2.1 フォルダ構成
```
attention-distribution-test/
├── attention_distribution_testApp.swift (メインアプリファイル)
├── Views/
│   ├── ContentView.swift (メインナビゲーション管理)
│   ├── StartView.swift (スタート画面 + 開始確認ダイアログ)
│   ├── CountdownView.swift (カウントダウン画面)
│   ├── TestView.swift (メイン検査画面 + 中断確認ダイアログ)
│   ├── ResultView.swift (結果画面)
│   └── HistoryView.swift (履歴画面)
├── Components/
│   ├── GridCell.swift (7x7グリッドのセル)
│   └── TimerView.swift (タイマー表示コンポーネント)
├── Models/
│   ├── TestModel.swift (検査の状態管理)
│   ├── TestResult.swift (検査結果データ)
│   └── GameState.swift (ゲーム状態の列挙型)
├── ViewModels/
│   ├── TestViewModel.swift (メイン検査のビジネスロジック)
│   └── HistoryViewModel.swift (履歴管理)
├── Services/
│   ├── DataServiceProtocol.swift (データ保存・読み込みサービス)
│   └── TimerServiceProtocol.swift (時間計測サービス)
└── Assets.xcassets/ (アプリアイコン、色設定など)
    ├── Contents.json
    ├── AccentColor.colorset/
    └── AppIcon.appiconset/
```

### 2.2 アーキテクチャパターン
- **MVVM (Model-View-ViewModel)** パターンを採用
- **責任分離**: UI、ビジネスロジック、データ層を明確に分離
- **再利用性**: コンポーネント化により保守性を向上

## 3. 基本機能仕様

### 3.1 検査内容
- 7×7のマス目に0～48の数字を表示
- 0は必ず中央のマス（3,3）に配置
- 1～48はランダムに配置（0の位置を除く）
- 受験者は0から順番に48まで数字をタップ
- 数字をタップ後、確認ボタンを押して次に進む
- 検査完了までの時間を測定

### 3.2 UI要素仕様

#### マス目
- **配置**: 画面いっぱいに7×7のグリッド表示
- **形状**: 正方形のセル
- **背景色**: 白（選択時は黄色半透明）
- **境界線**: 黒、1pt
- **数字**: 黒文字、各セルサイズの60%程度のフォントサイズ

#### タイマー
- **表示**: MM:SS形式（例：02:45）
- **動作**: テスト開始と同時にカウント開始
- **フォント**: モノスペース、太字

#### 次に押すべき数字表示
- **位置**: 画面上部中央
- **表示**: 大きなフォントサイズで現在の目標数字のみ表示
- **表示条件**: 0から48まで順次更新

#### 確認ボタン
- **位置**: 画面下部中央
- **ラベル**: "確認"
- **状態**: 数字をタップした時のみ活性化（青色）、非活性時は灰色
- **動作**: 正解なら次へ進む、間違いならエラーメッセージ表示

#### 中断ボタン
- **位置**: タイマーの下
- **ラベル**: "やめる"
- **スタイル**: 赤色背景、白文字
- **動作**: 確認ダイアログ → スタート画面に戻る

#### エラーメッセージ
- **位置**: 次に押すべき数字表示の下
- **内容**: "正しい数字をタップしてください"
- **色**: 赤色
- **表示条件**: 間違った数字で確認ボタンを押した時に表示
- **消去**: 新しい数字をタップした時に自動消去

## 4. 操作フロー

### 4.1 基本操作
1. スタート画面で「検査開始」ボタンをタップ
2. 「検査を開始しますか？」確認ダイアログ表示
3. 「はい」選択 → 3秒カウントダウン画面表示（3、2、1）
4. 検査画面に自動遷移と同時にタイマー開始、数字配置完了
5. 目標数字「0」が表示される
6. 受験者が「0」をタップ（セルが黄色に変化）
7. 確認ボタンをタップ
   - 正解の場合 → 目標数字「1」に更新
   - 不正解の場合 → エラーメッセージ表示、選択状態リセット
8. 「1」をタップ → 確認ボタンをタップ → 目標数字「2」に更新
9. この手順を「48」まで繰り返す
10. 「48」の確認ボタンタップ完了 → 結果画面へ遷移

### 4.2 エラーハンドリング
- **正しいタップ**: セルが黄色に変化、確認ボタンが活性化
- **間違いタップ**: セルが黄色に変化、確認ボタンは活性化
- **間違いの確認**: 確認ボタンタップ時にエラーメッセージ表示、選択状態リセット

## 5. 画面設計

### 5.1 スタート画面
```
┌─────────────────────────┐
│        [アイコン]        │
│    注意配分検査         │
│   運転適正検査          │
│                         │
│   [検査についての説明]   │
│                         │
│      [検査開始]         │
│                         │
│      [履歴確認]         │
│                         │
└─────────────────────────┘
```

### 5.2 カウントダウン画面
```
┌─────────────────────────┐
│                         │
│                         │
│                         │
│          3              │ ← 3、2、1と1秒ごとに変化（白文字、黒背景）
│                         │
│                         │
│                         │
└─────────────────────────┘
```

### 5.3 メイン検査画面
```
┌─────────────────────────┐
│      02:45              │ ← タイマー表示（MM:SS）
│      [やめる]           │ ← 中断ボタン（赤色）
│         5               │ ← 次に押すべき数字（大きく表示）
│                         │ ← エラーメッセージ表示エリア
│ ┌─┬─┬─┬─┬─┬─┬─┐ │
│ │12│03│45│...│  │  │  │ │
│ ├─┼─┼─┼─┼─┼─┼─┤ │
│ │  │37│  │...│  │  │08│ │
│ ├─┼─┼─┼─┼─┼─┼─┤ │
│ │29│  │15│...│  │42│  │ │
│ ├─┼─┼─┼─┼─┼─┼─┤ │
│ │  │  │  │ 0 │  │  │  │ │ ← 中央に0固定
│ ├─┼─┼─┼─┼─┼─┼─┤ │
│ │  │  │  │...│  │  │  │ │
│ ├─┼─┼─┼─┼─┼─┼─┤ │
│ │  │  │  │...│  │  │  │ │
│ ├─┼─┼─┼─┼─┼─┼─┤ │
│ │  │  │  │...│  │  │  │ │
│ └─┴─┴─┴─┴─┴─┴─┘ │
│                         │
│      [確認]             │ ← 確認ボタン（選択時：青、非選択時：灰色）
└─────────────────────────┘
```

### 5.4 結果画面
```
┌─────────────────────────┐
│                         │
│      検査終了           │
│                         │
│   完了時間              │
│     02:45               │ ← MM:SS形式、大きなフォント
│                         │
│  [メイン画面へ戻る]     │
│                         │
│                         │
└─────────────────────────┘
```

### 5.5 履歴画面
```
┌─────────────────────────┐
│       履歴    [戻る]    │ ← ナビゲーションバー
│                         │
│ 2025/08/15 14:30  02:45 │
│ 2025/08/14 10:15  03:12 │ ← 日付時刻と完了時間
│ 2025/08/13 16:45  02:58 │
│ 2025/08/12 09:30  03:05 │
│                         │
│                         │
└─────────────────────────┘
```

## 6. データ仕様

### 6.1 Models定義
#### TestModel
- 現在の検査状態（次に押すべき数字、グリッド配置、選択状態）
- ゲーム進行状況の管理
- グリッド生成ロジック（中央に0、その他1-48をシャッフル）

#### TestResult 
- id: UUID
- date: Date（検査終了日時）
- completionTime: TimeInterval（完了時間、秒）
- startTime: Date（検査開始日時）
- endTime: Date（検査終了日時）

#### GameState
- .notStarted（未開始）
- .inProgress（検査中）
- .completed（完了）
- .cancelled（中断）

### 6.2 データ保存
- **方法**: UserDefaults（DataServiceで管理）
- **保存先**: ローカルストレージ
- **容量制限**: 直近100件まで
- **フォーマット**: JSON（ISO8601日付形式）

## 7. 技術仕様

### 7.1 開発環境
- **言語**: Swift
- **フレームワーク**: SwiftUI
- **最小iOS**: iOS 15.0（推定）
- **対応デバイス**: iPhone、iPad
- **アーキテクチャ**: MVVM

### 7.2 画面サイズ対応
- **グリッド**: GeometryReaderを使用して動的サイズ調整
- **セルサイズ**: 利用可能領域に基づいて計算
- **フォントサイズ**: セルサイズの60%に設定
- **ナビゲーション**: StackNavigationViewStyleでiPhone/iPad対応

### 7.3 パフォーマンス要件
- **応答性**: タップ反応は即座に処理
- **精度**: 0.1秒間隔での時間計測（TimerServiceで管理）
- **安定性**: Timer適切なクリーンアップでメモリリーク防止

## 8. Services仕様

### 8.1 TimerServiceProtocol
- プロトコルベースの設計で、MockTimerServiceでのテストサポート
- 0.1秒間隔での高精度タイマー
- Combineパブリッシャーでリアルタイム更新
- 開始、停止、リセット機能

### 8.2 DataServiceProtocol  
- プロトコルベースの設計で、MockDataServiceでのテスト・プレビューサポート
- UserDefaultsでの永続化
- JSONエンコード/デコード（ISO8601日付形式）
- 検査結果の保存・読み込み
- 履歴データの管理（最大100件、新しい順）

## 9. 実装の特徴

### 9.1 状態管理
- **TestViewModel**: `@MainActor`で UI更新の安全性確保
- **選択状態**: タップ時に即座に視覚フィードバック（黄色背景）
- **エラー状態**: 新しいタップで自動クリア

### 9.2 UI/UX
- **確認ボタン**: 選択状態に応じた色変化（青/灰色）
- **レスポンシブデザイン**: GeometryReaderによる動的レイアウト
- **アニメーション**: なし（シンプルな即座の状態変化）

### 9.3 データ永続化
- **非同期処理**: async/awaitを使用したデータ操作
- **エラーハンドリング**: try/catchでの堅牢なエラー処理
- **モックデータ**: プレビュー用の模擬データ生成機能

## 10. セキュリティ・プライバシー
- **データ暗号化**: UserDefaultsでのローカル保存
- **プライバシー**: 個人を特定できる情報は保存しない
- **データ共有**: 外部送信なし

## 11. 今後の拡張可能性
- **統計機能**: 平均時間、改善傾向の表示
- **設定機能**: グリッドサイズの調整
- **エクスポート**: CSV形式でのデータ出力
- **複数検査パターン**: 異なる配置・範囲の検査追加
- **アクセシビリティ**: VoiceOverサポート
